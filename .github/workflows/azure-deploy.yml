name: Deploy to Azure Web App

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: ReeseJonesHoldingsUIs
  AZURE_WEBAPP_PACKAGE_PATH: '.'
  DOTNET_VERSION: '4.8.x'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: nuget/setup-nuget@v2
        with:
          nuget-version: 'latest'

      - name: Activate DevExpress License
        shell: pwsh
        run: |
          Write-Host "Activating DevExpress license..."
          
          $licenseDir = "$env:APPDATA\DevExpress"
          if (!(Test-Path $licenseDir)) {
            New-Item -ItemType Directory -Path $licenseDir -Force | Out-Null
          }
          
          $licenseFile = Join-Path $licenseDir "DevExpress_License.txt"
          $licenseKey = "${{ secrets.DEVEXPRESS_LICENSE_KEY }}"
          
          if ([string]::IsNullOrWhiteSpace($licenseKey)) {
            Write-Error "DEVEXPRESS_LICENSE_KEY secret is not set or is empty"
            exit 1
          }
          
          # Write license key (no newline to avoid formatting issues)
          Set-Content -Path $licenseFile -Value $licenseKey -NoNewline -Force
          
          Write-Host "License file created at: $licenseFile"
          Write-Host "License key length: $($licenseKey.Length) characters"
          Write-Host "License key starts with: $($licenseKey.Substring(0, [Math]::Min(10, $licenseKey.Length)))"
          
          # Verify file was written
          if (Test-Path $licenseFile) {
            $content = Get-Content $licenseFile -Raw
            Write-Host "âœ“ License file verified (size: $($content.Length) bytes)"
          } else {
            Write-Error "Failed to create license file"
            exit 1
          }

      - name: Configure DevExpress NuGet Feed
        shell: pwsh
        env:
          DX_KEY: ${{ secrets.DEVEXPRESS_NUGET_KEY }}
        run: |
          Write-Host "Configuring DevExpress NuGet authentication..."
          
          $apiKey = $env:DX_KEY
          
          if ([string]::IsNullOrWhiteSpace($apiKey)) {
            Write-Host "ERROR: DEVEXPRESS_NUGET_KEY secret is empty or not set!"
            Write-Host "You need to set the DEVEXPRESS_NUGET_KEY secret in GitHub."
            Write-Host "Get it from: https://nuget.devexpress.com/"
            exit 1
          }
          
          Write-Host "API Key received - Length: $($apiKey.Length) chars"
          Write-Host "API Key first 10 chars: $($apiKey.Substring(0, [Math]::Min(10, $apiKey.Length)))..."
          
          $nugetConfigPath = Join-Path $env:GITHUB_WORKSPACE "NuGet.Config"
          
          # DevExpress uses the API key in the URL itself for v3 feeds
          $devExpressUrl = "https://nuget.devexpress.com/$apiKey/api/v3/index.json"
          
          $xml = '<?xml version="1.0" encoding="utf-8"?>'
          $xml += '<configuration>'
          $xml += '<packageSources>'
          $xml += '<clear />'
          $xml += '<add key="nuget.org" value="https://api.nuget.org/v3/index.json" protocolVersion="3" />'
          $xml += "<add key=""DevExpress"" value=""$devExpressUrl"" protocolVersion=""3"" />"
          $xml += '</packageSources>'
          $xml += '</configuration>'
          
          [System.IO.File]::WriteAllText($nugetConfigPath, $xml, [System.Text.Encoding]::UTF8)
          
          Write-Host "Created NuGet.Config at: $nugetConfigPath"
          Write-Host "DevExpress feed URL configured (API key embedded in URL)"

      - name: Restore NuGet packages
        shell: pwsh
        run: |
          Write-Host "Starting NuGet restore with explicit config..."
          
          $nugetConfigPath = Join-Path $env:GITHUB_WORKSPACE "NuGet.Config"
          
          if (Test-Path $nugetConfigPath) {
            Write-Host "Using config: $nugetConfigPath"
          } else {
            Write-Host "ERROR: Config not found!"
            exit 1
          }
          
          # Use explicit config file
          nuget restore ReeseJonesHoldingsUIs.sln `
            -ConfigFile $nugetConfigPath `
            -NonInteractive `
            -Verbosity detailed `
            -NoCache

      - name: Build solution
        shell: pwsh
        env:
          DEVEXPRESS_NUGET_API_KEY: ${{ secrets.DEVEXPRESS_NUGET_KEY }}
        run: |
          Write-Host "Building solution..."
          
          # Verify license file exists
          $licensePath = Join-Path $env:APPDATA "DevExpress\DevExpress_License.txt"
          if (Test-Path $licensePath) {
            $licenseSize = (Get-Item $licensePath).Length
            Write-Host "License file found: $licensePath ($licenseSize bytes)"
          } else {
            Write-Host "WARNING: License file not found at $licensePath"
          }
          
          # Build and publish the web application
          msbuild ReeseJonesHoldingsUIs\ReeseJonesHoldingsUIs.csproj `
            /p:Configuration=Release `
            /p:Platform=AnyCPU `
            /p:DevExpressLicenseKey="${{ secrets.DEVEXPRESS_LICENSE_KEY }}" `
            /p:DeployOnBuild=true `
            /p:PublishUrl=publish `
            /p:WebPublishMethod=FileSystem `
            /p:DeleteExistingFiles=true `
            /p:CopyAllFilesToSingleFolderForPackageDependsOn=CollectGlobalResourcesForPublish `
            /p:AutoParameterizationWebConfigConnectionStrings=false `
            /p:MarkWebConfigAssistFilesAsExclude=false `
            /p:ExcludeGeneratedDebugSymbol=false `
            /p:CopyWebApplication=true `
            /p:OutDir=obj\Release\ `
            /t:Rebuild`;WebPublish `
            /verbosity:minimal
          
          Write-Host "Build completed"
          
          # Verify publish folder and DevExpress DLLs
          $publishPath = Join-Path $env:GITHUB_WORKSPACE "ReeseJonesHoldingsUIs\publish"
          if (Test-Path $publishPath) {
            Write-Host "Publish folder created at: $publishPath"
            $fileCount = (Get-ChildItem -Path $publishPath -Recurse -File | Measure-Object).Count
            Write-Host "Total files in publish folder: $fileCount"
            
            # Check for bin folder
            $binPath = Join-Path $publishPath "bin"
            if (Test-Path $binPath) {
              Write-Host "Bin folder exists"
              
              # List all DLLs
              $allDlls = Get-ChildItem -Path $binPath -Filter "*.dll"
              Write-Host "Total DLLs in bin: $($allDlls.Count)"
              
              # Check for DevExpress DLLs specifically
              $dxDlls = $allDlls | Where-Object { $_.Name -like "DevExpress*.dll" }
              if ($dxDlls) {
                Write-Host "Found $($dxDlls.Count) DevExpress DLLs:"
                $dxDlls | ForEach-Object { Write-Host "  - $($_.Name)" }
              } else {
                Write-Host "ERROR: No DevExpress DLLs found in bin folder!"
                Write-Host "Listing all DLLs for reference:"
                $allDlls | Select-Object -First 20 | ForEach-Object { Write-Host "  - $($_.Name)" }
                exit 1
              }
            } else {
              Write-Host "ERROR: Bin folder not found in publish directory!"
              exit 1
            }
          } else {
            Write-Host "ERROR: Publish folder not created!"
            exit 1
          }

      - name: Upload artifact for deployment
        uses: actions/upload-artifact@v4
        with:
          name: webapp
          path: ReeseJonesHoldingsUIs/publish

  deploy:
    runs-on: windows-latest
    needs: build
    environment:
      name: 'Production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: webapp

      - name: Verify artifact contents
        shell: pwsh
        run: |
          Write-Host "Verifying downloaded artifact..."
          
          $currentPath = Get-Location
          Write-Host "Current path: $currentPath"
          
          # List all files
          Write-Host "`nAll files in artifact:"
          Get-ChildItem -Recurse -File | Select-Object -First 30 | ForEach-Object { Write-Host "  $($_.FullName)" }
          
          # Check bin folder
          if (Test-Path "bin") {
            Write-Host "`nBin folder exists!"
            $dxDlls = Get-ChildItem -Path "bin" -Filter "DevExpress*.dll"
            Write-Host "DevExpress DLLs in bin: $($dxDlls.Count)"
            $dxDlls | ForEach-Object { Write-Host "  - $($_.Name) ($([math]::Round($_.Length/1KB, 2)) KB)" }
          } else {
            Write-Host "`nWARNING: No bin folder found in artifact!"
          }
          
          # Check for Web.config
          if (Test-Path "Web.config") {
            Write-Host "`nWeb.config found"
          }

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: .

      - name: Post-Deployment Verification
        shell: pwsh
        run: |
          Write-Host "Deployment completed. Please verify the following:"
          Write-Host "1. Check Azure Kudu console: https://${{ env.AZURE_WEBAPP_NAME }}.scm.azurewebsites.net/DebugConsole"
          Write-Host "2. Navigate to: site/wwwroot/bin"
          Write-Host "3. Look for DevExpress*.dll files"
          Write-Host ""
          Write-Host "If DLLs are missing from Azure but present in artifact:"
          Write-Host "- Check App Service Configuration > General Settings > Stack = .NET Framework 4.8"
          Write-Host "- Check App Service Configuration > Application Settings for any blocking settings"
          Write-Host "- Try restarting the App Service"
